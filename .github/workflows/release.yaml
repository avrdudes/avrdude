name: Build avrdude with Emscripten

on:
  release:
    types: [created]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14

      - name: Configure CMake
        env:
          EMSDK: ${{ env.EMSDK }}
        run: |
          cmake -B build -S . \
            -DCMAKE_TOOLCHAIN_FILE=$EMSDK/upstream/emscripten/cmake/Modules/Platform/Emscripten.cmake

      - name: Build avrdude
        run: cmake --build build --target avrdude
      
      - name: Configure Git user identity
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"


      - name: Create orphan branch and push artifacts
        run: |
          git checkout --orphan new-branch
          git reset --hard
          mkdir -p build/test
          cp build/test/avrdude.wasm build/test/avrdude.js build/test/avrdude.conf .
          git add .
          git commit -m "Add avrdude artifacts"
          git push origin new-branch
